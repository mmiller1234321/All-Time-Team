<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>All Time Teams</title>
  <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body {
      background-color: #71A95A; /* Green like Wrigley Field grass */
      font-family: Arial, sans-serif;
    }
    .container {
      margin-top: 20px;
      background-color: #FAFAD2; /* Sand color */
      padding: 20px;
      border-radius: 10px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
      background-color: #FAFAD2; /* Sand color */
    }
    th, td {
      border: 1px solid #dddddd;
      text-align: left;
      padding: 8px;
    }
    th {
      background-color: #f2f2f2; /* Light gray header */
    }
    .stat-square {
      width: 30px;
      height: 30px;
      background-color: #ffffff; /* White square */
      border: 1px solid #dddddd;
    }
  </style>
</head>
<body>
<div class="container">
  <div class="d-flex justify-content-between align-items-center">
    <h2>All Time Teams</h2>
    <div>
      <button type="button" class="btn btn-primary" id="previousGamesButton">Previous Games</button>
      <button type="button" class="btn btn-primary" id="instructionsButton">Instructions</button>
    </div>
  </div>
  <table class="table table-bordered">
    <thead>
      <tr>
        <th id="teamLabel"></th>
        <th>Position</th>
        <th id="statLabel">Stat</th>
        <th>Submit Player</th>
      </tr>
    </thead>
    <tbody id="playerRows">
      <!-- Table rows will be generated dynamically -->
    </tbody>
  </table>

  <div>
    <p>Total Score: <span id="totalScore"></span></p>
    <p>High Score: <span id="highScore"></span></p>
    <p>Optimal Score: <span id="optimalScore"></span></p>
  </div>
</div>

<div class="modal fade" id="instructionsModal" tabindex="-1" role="dialog" aria-labelledby="instructionsModalLabel" aria-hidden="true">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="instructionsModalLabel">Instructions</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <p>Build an All Time Team! Choose a player who played for the given team and position. The score will be that player's highest season stat total for that category. Your total score is the sum of all the players' scores. Have fun!</p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>

<!-- Modal for Previous Games -->
<div class="modal fade" id="previousGamesModal" tabindex="-1" role="dialog" aria-labelledby="previousGamesModalLabel" aria-hidden="true">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="previousGamesModalLabel">Previous Games</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <table class="table table-bordered">
          <thead>
            <tr>
              <th>Gameboard ID</th>
              <th>Team Name</th>
              <th>Stat Name</th>
              <th>Play Now</th>
            </tr>
          </thead>
          <tbody id="previousGamesTableBody">
            <!-- Previous games will be dynamically inserted here -->
          </tbody>
        </table>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>

<script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.9.2/dist/umd/popper.min.js"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
<script>
document.addEventListener("DOMContentLoaded", function() {
  var submittedPlayers = [];
  var submissionButtonCount = 9;
  var enabledSubmitButtons = submissionButtonCount; // Track the number of enabled submit buttons
  var teamLabelValue = ''; // Variable to store team label value
  var statLabelValue = ''; // Variable to store stat label value
  var gameboardId = ''; // Variable to store gameboard ID

  document.getElementById('previousGamesButton').addEventListener('click', function() {
    var baseUrl = window.location.protocol + '//' + window.location.hostname;
    fetch(baseUrl + '/fetch-previous-gameboards')
      .then(response => response.json())
      .then(gameboards => {
        var tableBody = document.getElementById('previousGamesTableBody');
        tableBody.innerHTML = ''; // Clear existing rows
        gameboards.forEach(gameboard => {
          var row = document.createElement('tr');
          row.innerHTML = `
            <td>${gameboard.id}</td>
            <td>${gameboard.team_name}</td>
            <td>${gameboard.stat_name}</td>
            <td><button class="btn btn-link" onclick="loadGameboard(${gameboard.id})">Play Now!</button></td>
          `;
          tableBody.appendChild(row);
        });
        $('#previousGamesModal').modal('show'); // Show the modal
      })
      .catch(error => {
        console.error('Error fetching previous gameboards:', error);
      });
  });

  window.loadGameboard = function(gameboardId) {
    fetch(`${window.location.protocol + '//' + window.location.hostname}/gameboard/${gameboardId}`)
      .then(response => response.json())
      .then(data => {
        updatePageWithGameboard(data.gameboard);
        document.getElementById('highScore').innerText = data.high_score || 'N/A'; // Fetch high score when a gameboard is loaded
      })
      .catch(error => console.error('Error loading gameboard:', error));
  };

  function updatePageWithGameboard(gameboard) {
    document.getElementById('teamLabel').innerText = gameboard.team_name;
    document.getElementById('statLabel').innerText = gameboard.stat_name;
    // Additional updates as needed...
  }

  function fetchTeamStatPair() {
    var baseUrl = window.location.protocol + '//' + window.location.hostname;
    fetch(baseUrl + '/generateTeamStatPair/team-stat-pair')
      .then(response => response.json())
      .then(data => {
        updateLabels(data.team, data.stat, data.id);
        displayOptimalScore(data.perfect_score);
      })
      .catch(error => {
        console.error('Error fetching team and stat pair:', error);
      });
  }

  function updateLabels(team, stat, id) {
    teamLabelValue = team;
    statLabelValue = stat;
    gameboardId = id;
    document.getElementById('teamLabel').innerText = team;
    document.getElementById('statLabel').innerText = stat;
    document.getElementById('teamLabel').setAttribute('data-id', id);
  }

  function displayOptimalScore(optimalScore) {
    var optimalScoreElement = document.getElementById('optimalScore');
    optimalScoreElement.innerText = optimalScore || 'N/A';
  }

  function addPlayerRows() {
    var positions = ["C", "1B", "2B", "3B", "SS", "OF", "OF", "OF", "P"];
    var tbody = document.getElementById("playerRows");
    positions.forEach((position, index) => {
      var row = tbody.insertRow();
      var cellName = row.insertCell(0);
      var input = document.createElement("input");
      input.type = "text";
      input.className = "form-control player-input";
      input.placeholder = "Enter player's name";
      input.addEventListener('input', function() {
        autocomplete(this);
      });
      cellName.appendChild(input);

      var cellPosition = row.insertCell(1);
      cellPosition.textContent = position;

      var cellStat = row.insertCell(2);
      var statDiv = document.createElement("div");
      statDiv.className = "stat-square";
      cellStat.appendChild(statDiv);

      var cellSubmit = row.insertCell(3);
      var button = document.createElement("button");
      button.className = "btn btn-primary";
      button.textContent = "Submit";
      button.addEventListener('click', handleSubmit);
      cellSubmit.appendChild(button);
    });
  }

  function autocomplete(inputElement) {
    var currentFocus;
    var xhr = new XMLHttpRequest();
    xhr.onreadystatechange = function() {
      if (this.readyState === 4 && this.status === 200) {
        var suggestions = JSON.parse(this.responseText);
        closeAllLists();
        if (!inputElement.value || suggestions.length === 0) {
          return false;
        }
        currentFocus = -1;
        var autocompleteList = document.createElement("div");
        autocompleteList.setAttribute("id", inputElement.id + "autocomplete-list");
        autocompleteList.setAttribute("class", "autocomplete-items");
        inputElement.parentNode.appendChild(autocompleteList);
        suggestions.forEach(suggestion => {
          var suggestionItem = document.createElement("div");
          suggestionItem.innerHTML = "<strong>" + suggestion.fullName.substr(0, inputElement.value.length) + "</strong>" + suggestion.fullName.substr(inputElement.value.length);
          suggestionItem.innerHTML += "<br><small>Born in " + suggestion.birthYear + "</small>";
          suggestionItem.innerHTML += "<input type='hidden' value='" + suggestion.fullName + "'>";
          suggestionItem.addEventListener("click", function(e) {
            inputElement.value = this.getElementsByTagName("input")[0].value;
            closeAllLists();
          });
          autocompleteList.appendChild(suggestionItem);
        });
      }
    };
    var baseUrl = window.location.protocol + '//' + window.location.hostname;
    xhr.open("GET", baseUrl + "/autocomplete?query=" + encodeURIComponent(inputElement.value), true);
    xhr.send();

    function closeAllLists(elmnt) {
      var autocompleteItems = document.getElementsByClassName("autocomplete-items");
      for (var i = 0; i < autocompleteItems.length; i++) {
        if (elmnt !== autocompleteItems[i] && elmnt !== inputElement) {
          autocompleteItems[i].parentNode.removeChild(autocompleteItems[i]);
        }
      }
    }
  }

  document.addEventListener("input", function(e) {
    if (e.target.matches(".player-input")) {
      autocomplete(e.target);
    }
  });

  function handleSubmit(event) {
    var submitButton = event.target;
    if (submitButton.disabled) return;
    submitButton.disabled = true;
    enabledSubmitButtons--; // Decrement the count of enabled submit buttons

    var row = submitButton.closest("tr");
    var playerNameInput = row.cells[0].children[0];
    var playerName = playerNameInput.value.trim();

    if (submittedPlayers.includes(playerName)) {
      alert('Player has already been submitted. Please select a different player.');
      submitButton.disabled = false;
      enabledSubmitButtons++; // Increment the count of enabled submit buttons
      return;
    }

    if (playerName !== '') {
      var position = row.cells[1].textContent;
      var team = teamLabelValue; // Use global variable for team label value
      var stat = statLabelValue; // Use global variable for stat label value
      var id = document.getElementById('teamLabel').getAttribute('data-id');

      var baseUrl = window.location.protocol + '//' + window.location.hostname;
      var xhr = new XMLHttpRequest();
      xhr.open('GET', baseUrl + '/search?playerName=' + playerName + '&position=' + position + '&team=' + team + '&stat=' + stat + '&id=' + id, true);
      xhr.onload = function () {
        if (xhr.status === 200) {
          var statSquare = row.cells[2].children[0];
          var statValue = xhr.responseText;
          statSquare.textContent = (statValue === 'null') ? 'N/A' : statValue;
          updateTotalScore();
          submissionButtonCount--;
          if (enabledSubmitButtons === 0) { // If all submit buttons are disabled
            var totalScore = document.getElementById('totalScore').textContent;
            console.log('All buttons submitted. Total Score:', totalScore);
            sendFinalScore(totalScore, id); // Update to send the correct information
          }
        } else {
          console.error('Error fetching data:', xhr.statusText);
          submitButton.disabled = false;
          enabledSubmitButtons++; // Increment the count of enabled submit buttons
        }
      };
      xhr.onerror = function () {
        console.error('Error fetching data.');
        submitButton.disabled = false;
        enabledSubmitButtons++; // Increment the count of enabled submit buttons
      };
      xhr.send();
    } else {
      submitButton.disabled = false;
      enabledSubmitButtons++; // Increment the count of enabled submit buttons
    }
  }

  function updateTotalScore() {
    var statSquares = document.querySelectorAll('.stat-square');
    var totalScore = 0;
    statSquares.forEach(square => {
      var score = parseInt(square.textContent, 10);
      if (!isNaN(score)) totalScore += score;
    });
    document.getElementById('totalScore').textContent = totalScore;
  }

  function sendFinalScore(totalScore, gameboardId) {
    var team = teamLabelValue; // Use global variable for team label value
    var stat = statLabelValue; // Use global variable for stat label value
    var baseUrl = window.location.protocol + '//' + window.location.hostname;
    fetch(baseUrl + '/saveScore', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        total_score: totalScore,
        team_name: team,
        stat_name: stat,
        gameboard_id: gameboardId // Ensure the correct key name is used here
      })
    })
    .then(response => response.json())
    .then(result => {
      console.log('Response from save-score:', result.message);
      alert('All buttons submitted!\nTotal Score: ' + totalScore);
    })
    .catch(error => console.error('Failed to save score:', error));
  }

  // Initial setup
  fetchTeamStatPair();
  addPlayerRows();
  document.getElementById('instructionsButton').addEventListener('click', function() {
    $('#instructionsModal').modal('show');
  });
});
</script>

</body>
</html>


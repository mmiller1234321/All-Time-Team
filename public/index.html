<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>All Time Teams</title>
  <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body {
      background-color: #71A95A; /* Green like Wrigley Field grass */
      font-family: Arial, sans-serif;
      color: #333; /* Ensuring good contrast */
      padding: 0 5%; /* Padding for small screens */
    }
    .container {
      margin-top: 10px;
      background-color: #FAFAD2; /* Sand color */
      padding: 10px;
      border-radius: 5px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
    }
    th, td {
      border: 1px solid #dddddd;
      text-align: left;
      padding: 8px;
    }
    th {
      background-color: #f2f2f2; /* Light gray header */
    }
    input[type="text"], button {
      width: 100%; /* Full width for better accessibility */
      margin: 4px 0; /* Spacing for touch targets */
      font-size: 16px; /* Adequate font size for readability on mobile */
    }
    .alert-card {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      padding: 20px;
      background-color: rgba(255, 255, 255, 0.9); /* Semi-transparent background */
      z-index: 1050;
      overflow-y: auto; /* Enable vertical scroll if content exceeds screen height */
      display: none;
    }
    .alert-card-content {
      max-width: 800px; /* Limit max width for better readability */
      margin: 0 auto; /* Center content horizontally */
    }

    /* Media Query for Larger Screens */
    @media (min-width: 768px) {
      body {
        padding: 0 10%; /* Slightly larger padding on larger screens */
      }
      .container {
        margin-top: 20px;
        padding: 20px;
        border-radius: 10px;
      }
      table {
        margin-top: 20px;
      }
      input[type="text"], button {
        width: auto; /* Allow natural width */
        margin: 8px;
      }
      .alert-card-content {
        max-width: 70%; /* Adjust max width for better visibility on larger screens */
      }
    }
  </style>
</head>
<body>
<div class="container">
  <div class="d-flex justify-content-between align-items-center">
    <h2>All Time Teams</h2>
    <div>
      <button type="button" class="btn btn-primary" id="previousGamesButton">Click Here To Play</button>
      <button type="button" class="btn btn-primary" id="instructionsButton">Instructions</button>
    </div>
  </div>
  <table class="table table-bordered">
    <thead>
      <tr>
        <th id="teamLabel"></th>
        <th>Position</th>
        <th id="statLabel">Stat</th>
        <th>Submit Player</th>
      </tr>
    </thead>
    <tbody id="playerRows">
      <!-- Table rows will be generated dynamically -->
    </tbody>
  </table>

  <div>
    <p>Total Score: <span id="totalScore">0</span></p>
    <p>High Score: <span id="highScore"></span></p>
    <p>Optimal Score: <span id="optimalScore"></span></p>
  </div>
</div>

<div class="modal fade" id="instructionsModal" tabindex="-1" role="dialog" aria-labelledby="instructionsModalLabel" aria-hidden="true">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="instructionsModalLabel">Instructions</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <p>Build an All Time Team! Choose a player who played for the given team and position. The score will be that player's highest season stat total for that category. Your total score is the sum of all the players' scores. Have fun!</p>
        <h6>Stat Abbreviations Key:</h6>
        <table class="table table-bordered">
          <thead>
            <tr>
              <th>Abbreviation</th>
              <th>Meaning</th>
            </tr>
          </thead>
          <tbody>
            <tr><td>2B</td><td>Doubles</td></tr>
            <tr><td>3B</td><td>Triples</td></tr>
            <tr><td>BB</td><td>Walks</td></tr>
            <tr><td>H</td><td>Hits</td></tr>
            <tr><td>HR</td><td>Home Runs</td></tr>
            <tr><td>IBB</td><td>Intentional Walks</td></tr>
            <tr><td>R</td><td>Runs</td></tr>
            <tr><td>RBI</td><td>Runs Batted In</td></tr>
            <tr><td>SB</td><td>Stolen Bases</td></tr>
          </tbody>
        </table>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>

<!-- Alert card for Previous Games -->
<div id="previousGamesAlert" class="alert alert-info alert-card">
  <div class="alert-card-content">
    <button type="button" class="close" onclick="closeAlertCard()">&times;</button>
    <h4 class="alert-heading">Welcome to All Time Teams</h4>
    <p>Click <button type="button" class="btn btn-link p-0" onclick="playTodaysGame()">Play Today's Game</button> to play. Or see all of our games in the list below (more added all the time)!</p>
    <table class="table table-bordered">
      <thead>
        <tr>
          <th>Gameboard ID</th>
          <th>Team Name</th>
          <th>Stat Name</th>
          <th>Play Now</th>
        </tr>
      </thead>
      <tbody id="previousGamesTableBody">
        <!-- Previous games will be dynamically inserted here -->
      </tbody>
    </table>
  </div>
</div>

<script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.9.2/dist/umd/popper.min.js"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
<script>
document.addEventListener("DOMContentLoaded", function() {
  var submittedPlayers = [];
  var submissionButtonCount = 9;
  var enabledSubmitButtons = submissionButtonCount;
  var teamLabelValue = '';
  var statLabelValue = '';
  var gameboardId = '';

  document.getElementById('previousGamesButton').addEventListener('click', function() {
    var baseUrl = window.location.protocol + '//' + window.location.hostname;
    fetch(baseUrl + '/fetch-previous-gameboards')
      .then(response => response.json())
      .then(gameboards => {
        var tableBody = document.getElementById('previousGamesTableBody');
        tableBody.innerHTML = '';
        gameboards.forEach(gameboard => {
          var row = document.createElement('tr');
          row.innerHTML = `
            <td>${gameboard.id}</td>
            <td>${gameboard.team_name}</td>
            <td>${gameboard.stat_name}</td>
            <td><button class="btn btn-link" onclick="loadGameboard(${gameboard.id})">Play Now!</button></td>
          `;
          tableBody.appendChild(row);
        });
        document.getElementById('previousGamesAlert').style.display = 'block';
      })
      .catch(error => {
        console.error('Error fetching previous gameboards:', error);
      });
  });

  window.closeAlertCard = function() {
    document.getElementById('previousGamesAlert').style.display = 'none';
  };

  window.playTodaysGame = function() {
    location.reload();
  };

  window.loadGameboard = function(gameboardId) {
    fetch(`${window.location.protocol + '//' + window.location.hostname}/gameboard/${gameboardId}`)
      .then(response => response.json())
      .then(data => {
        if (data.gameboard) {
          updatePageWithGameboard(data.gameboard);
          document.getElementById('highScore').innerText = data.high_score || 'N/A';
          closeAlertCard();
        } else {
          console.error('No gameboard data found for ID:', gameboardId);
        }
      })
      .catch(error => console.error('Error loading gameboard:', error));
  };

  function updatePageWithGameboard(gameboard) {
    document.getElementById('teamLabel').innerText = gameboard.team_name;
    document.getElementById('statLabel').innerText = gameboard.stat_name;
    teamLabelValue = gameboard.team_name;
    statLabelValue = gameboard.stat_name;
    gameboardId = gameboard.id;
  }

  function fetchTeamStatPair() {
    var baseUrl = window.location.protocol + '//' + window.location.hostname;
    fetch(baseUrl + '/generateTeamStatPair/team-stat-pair')
      .then(response => response.json())
      .then(data => {
        updateLabels(data.team, data.stat, data.id);
        displayOptimalScore(data.perfect_score);
      })
      .catch(error => {
        console.error('Error fetching team and stat pair:', error);
      });
  }

  function updateLabels(team, stat, id) {
    teamLabelValue = team;
    statLabelValue = stat;
    gameboardId = id;
    document.getElementById('teamLabel').innerText = team;
    document.getElementById('statLabel').innerText = stat;
    document.getElementById('teamLabel').setAttribute('data-id', id);

    fetch(`${window.location.protocol + '//' + window.location.hostname}/fetch-high-score/${id}`)
      .then(response => response.json())
      .then(data => {
        document.getElementById('highScore').innerText = data.high_score || 'N/A';
      })
      .catch(error => {
        console.error('Error fetching high score:', error);
      });
  }

  function displayOptimalScore(optimalScore) {
    var optimalScoreElement = document.getElementById('optimalScore');
    optimalScoreElement.innerText = optimalScore || 'N/A';
  }

  function addPlayerRows() {
    var positions = ["C", "1B", "2B", "3B", "SS", "OF", "OF", "OF", "P"];
    var tbody = document.getElementById("playerRows");
    positions.forEach((position, index) => {
      var row = tbody.insertRow();
      var cellName = row.insertCell(0);
      var input = document.createElement("input");
      input.type = "text";
      input.className = "form-control player-input";
      input.placeholder = "Enter player's name";
      input.addEventListener('input', function() {
        autocomplete(this);
      });
      cellName.appendChild(input);

      var cellPosition = row.insertCell(1);
      cellPosition.textContent = position;

      var cellStat = row.insertCell(2);

      var cellSubmit = row.insertCell(3);
      var button = document.createElement("button");
      button.className = "btn btn-primary";
      button.textContent = "Submit";
      button.addEventListener('click', handleSubmit);
      cellSubmit.appendChild(button);
    });
  }

  function autocomplete(inputElement) {
    var currentFocus;
    var xhr = new XMLHttpRequest();
    xhr.onreadystatechange = function() {
      if (this.readyState === 4 && this.status === 200) {
        var suggestions = JSON.parse(this.responseText);
        closeAllLists();
        if (!inputElement.value || suggestions.length === 0) {
          return false;
        }
        currentFocus = -1;
        var autocompleteList = document.createElement("div");
        autocompleteList.setAttribute("id", inputElement.id + "autocomplete-list");
        autocompleteList.setAttribute("class", "autocomplete-items");
        inputElement.parentNode.appendChild(autocompleteList);
        suggestions.forEach(suggestion => {
          var suggestionItem = document.createElement("div");
          suggestionItem.innerHTML = "<strong>" + suggestion.fullName.substr(0, inputElement.value.length) + "</strong>" + suggestion.fullName.substr(inputElement.value.length);
          suggestionItem.innerHTML += " <br><small>born in " + suggestion.birthYear + "</small>";
          suggestionItem.innerHTML += "<input type='hidden' value='" + suggestion.fullName + "'>";
          suggestionItem.addEventListener("click", function(e) {
            inputElement.value = this.getElementsByTagName("input")[0].value;
            closeAllLists();
          });
          autocompleteList.appendChild(suggestionItem);
        });
      }
    };
    var baseUrl = window.location.protocol + '//' + window.location.hostname;
    xhr.open("GET", baseUrl + "/autocomplete?query=" + encodeURIComponent(inputElement.value), true);
    xhr.send();

    function closeAllLists(elmnt) {
      var autocompleteItems = document.getElementsByClassName("autocomplete-items");
      for (var i = 0; i < autocompleteItems.length; i++) {
        if (elmnt !== autocompleteItems[i] && elmnt !== inputElement) {
          autocompleteItems[i].parentNode.removeChild(autocompleteItems[i]);
        }
      }
    }
  }

  document.addEventListener("input", function(e) {
    if (e.target.matches(".player-input")) {
      autocomplete(e.target);
    }
  });

  function handleSubmit(event) {
    var submitButton = event.target;
    if (submitButton.disabled) return;
    submitButton.disabled = true;
    enabledSubmitButtons--;

    var row = submitButton.closest("tr");
    var playerNameInput = row.cells[0].children[0];
    var playerName = playerNameInput.value.trim();
    playerNameInput.disabled = true;

    if (submittedPlayers.includes(playerName)) {
      alert('Player has already been submitted. Please select a different player.');
      submitButton.disabled = false;
      playerNameInput.disabled = false;
      enabledSubmitButtons++;
      return;
    }

    if (playerName !== '') {
      var position = row.cells[1].textContent;
      var team = teamLabelValue;
      var stat = statLabelValue;
      var id = gameboardId;

      var baseUrl = window.location.protocol + '//' + window.location.hostname;
      var xhr = new XMLHttpRequest();
      xhr.open('GET', baseUrl + '/search?playerName=' + encodeURIComponent(playerName) + '&position=' + encodeURIComponent(position) + '&team=' + encodeURIComponent(team) + '&stat=' + encodeURIComponent(stat) + '&id=' + encodeURIComponent(id), true);
      xhr.onload = function () {
        if (xhr.status === 200) {
          var statCell = row.cells[2];
          var statValue = xhr.responseText;
          statCell.textContent = (statValue === 'null') ? 'N/A' : statValue;
          statCell.classList.add('stat-square');
          updateTotalScore();
          submissionButtonCount--;
          if (enabledSubmitButtons === 0) {
            var totalScore = document.getElementById('totalScore').textContent;
            console.log('All buttons submitted. Total Score:', totalScore);
            sendFinalScore(totalScore, id);
          }
        } else {
          console.error('Error fetching data:', xhr.statusText);
          submitButton.disabled = false;
          playerNameInput.disabled = false;
          enabledSubmitButtons++;
        }
      };
      xhr.onerror = function () {
        console.error('Error fetching data.');
        submitButton.disabled = false;
        playerNameInput.disabled = false;
        enabledSubmitButtons++;
      };
      xhr.send();
    } else {
      submitButton.disabled = false;
      playerNameInput.disabled = false;
      enabledSubmitButtons++;
    }
  }

  function updateTotalScore() {
    var statSquares = document.querySelectorAll('.stat-square');
    var totalScore = 0;
    statSquares.forEach(square => {
      var score = parseInt(square.textContent, 10);
      if (!isNaN(score)) totalScore += score;
    });
    document.getElementById('totalScore').textContent = totalScore;
  }

  function sendFinalScore(totalScore, gameboardId) {
    var team = teamLabelValue;
    var stat = statLabelValue;
    var baseUrl = window.location.protocol + '//' + window.location.hostname;
    fetch(baseUrl + '/saveScore', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        total_score: totalScore,
        team_name: team,
        stat_name: stat,
        gameboard_id: gameboardId
      })
    })
    .then(response => response.json())
    .then(result => {
      console.log('Response from save-score:', result.message);
      alert('All buttons submitted!\nTotal Score: ' + totalScore);
    })
    .catch(error => console.error('Failed to save score:', error));
  }

  fetchTeamStatPair();
  addPlayerRows();
  document.getElementById('instructionsButton').addEventListener('click', function() {
    $('#instructionsModal').modal('show');
  });

  document.getElementById('previousGamesButton').click();
});
</script>

</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>All Time Teams</title>
<link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
<style>
  body {
    background-color: #71A95A; /* Green like Wrigley Field grass */
    font-family: Arial, sans-serif;
  }
  .container {
    margin-top: 20px;
    background-color: #FAFAD2; /* Sand color */
    padding: 20px;
    border-radius: 10px;
  }
  table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 20px;
    background-color: #FAFAD2; /* Sand color */
  }
  th, td {
    border: 1px solid #dddddd;
    text-align: left;
    padding: 8px;
  }
  th {
    background-color: #f2f2f2; /* Light gray header */
  }
  .stat-square {
    width: 30px;
    height: 30px;
    background-color: #ffffff; /* White square */
    border: 1px solid #dddddd;
  }
</style>
</head>
<body>

<div class="container">
  <div class="d-flex justify-content-between align-items-center">
    <h2>All Time Teams</h2>
    <button type="button" class="btn btn-primary" id="instructionsButton">Instructions</button>
  </div>
  <table class="table table-bordered">
    <thead>
      <tr>
        <th id="teamLabel"></th>
        <th>Position</th>
        <th id="statLabel">Stat</th> <!-- New column for Stat -->
        <th>Submit Player</th> <!-- New column for submit button -->
      </tr>
    </thead>
    <tbody id="playerRows">
      <!-- Table rows will be generated dynamically -->
    </tbody>
  </table>

  <!-- Total Score -->
  <div>
    <p>Total Score: <span id="totalScore"></span></p>
  </div>
</div>

<!-- Instructions Modal -->
<div class="modal fade" id="instructionsModal" tabindex="-1" role="dialog" aria-labelledby="instructionsModalLabel" aria-hidden="true">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="instructionsModalLabel">Instructions</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <p>Build an All Time Team! Choose a player who played for the given team and position. The score will be that player's highest season stat total for that category. Your total score is the sum of all the players' scores. Have fun!</p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>

<script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.9.2/dist/umd/popper.min.js"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
<script>
// Array to keep track of submitted player names
var submittedPlayers = [];
var lockedTeam = null;
var lockedStat = null;

function updateLabels() {
  // Lock team and stat name labels for 72 hours
  if (!lockedTeam || !lockedStat || Date.now() - lockedTeam.timestamp >= 72 * 60 * 60 * 1000) {
    // Add new labels, All Star NL/AL, Division, Hall of Famers, other 
    var teams = [
      "Arizona Diamondbacks", "Atlanta Braves", "Baltimore Orioles", "Boston Red Sox",
      "Chicago White Sox", "Chicago Cubs", "Cincinnati Reds", "Cleveland Guardians",
      "Colorado Rockies", "Detroit Tigers", "Houston Astros", "Kansas City Royals",
      "Los Angeles Angels of Anaheim", "Los Angeles Dodgers", "Miami Marlins", "Milwaukee Brewers",
      "Minnesota Twins", "New York Yankees", "New York Mets", "Oakland Athletics",
      "Philadelphia Phillies", "Pittsburgh Pirates", "San Diego Padres", "San Francisco Giants",
      "Seattle Mariners", "St. Louis Cardinals", "Tampa Bay Rays", "Texas Rangers",
      "Toronto Blue Jays", "Washington Nationals"
    ];
    var randomTeamIndex = Math.floor(Math.random() * teams.length);
    var randomTeam = teams[randomTeamIndex];
    document.getElementById('teamLabel').innerText = randomTeam;
    lockedTeam = { team: randomTeam, timestamp: Date.now() };

    var stats = ["r", "h", "2b", "3b", "hr", "rbi", "sb", "bb", "ibb"]; // Add additional stats here
    var randomStatIndex = Math.floor(Math.random() * stats.length);
    var randomStat = stats[randomStatIndex];
    document.getElementById('statLabel').innerText = randomStat;
    lockedStat = { stat: randomStat, timestamp: Date.now() };
  }

  // Add player rows
  addPlayerRows();
}

function handleSubmit(event) {
  var submitButton = event.target;
  if (submitButton.disabled) return; // Check if the button is already disabled
  submitButton.disabled = true; // Disable the button to prevent multiple submissions

  var playerNameInput = submitButton.parentElement.parentElement.children[0].children[0];
  var playerName = playerNameInput.value.trim(); // Trim whitespace

  // Check if the player has already been submitted
  if (submittedPlayers.includes(playerName)) {
    alert('Player has already been submitted. Please select a different player.');
    submitButton.disabled = false; // Re-enable the button
    return;
  }

  if (playerName !== '') {
    submittedPlayers.push(playerName); // Add the player to the submitted players list

    var position = submitButton.parentElement.parentElement.children[1].textContent;
    var team = document.getElementById('teamLabel').textContent;
    var stat = document.getElementById('statLabel').textContent; // Retrieve the value of the stats label

    // Dynamically determine the base URL
    var baseUrl = window.location.protocol + '//' + window.location.hostname;

    // Fetch data for the submitted player
    var xhr = new XMLHttpRequest();
    xhr.open('GET', baseUrl + '/search?playerName=' + playerName + '&position=' + position + '&team=' + team + '&stat=' + stat, true);
    xhr.onload = function () {
      if (xhr.status === 200) {
        var statSquare = submitButton.parentElement.parentElement.children[2].children[0];
        var statValue = xhr.responseText;
        statSquare.textContent = (statValue === '0') ? '0' : statValue; // Display '0' if no data found
        updateTotalScore(); // Update total score after each submission
      } else {
        console.error('Error fetching data:', xhr.statusText);
      }
    };
    xhr.onerror = function () {
      console.error('Error fetching data.');
    };
    xhr.send();
  }
}

function addPlayerRows() {
  var positions = ["C", "1B", "2B", "3B", "SS", "OF", "OF", "OF", "P"];
  var tbody = document.getElementById("playerRows");
  tbody.innerHTML = ''; // Clear existing rows
  for (var i = 0; i < 9; i++) {
    var row = document.createElement("tr");
    
    var playerNameCell = document.createElement("td");
    var playerNameInput = document.createElement("input");
    playerNameInput.type = "text";
    playerNameInput.className = "form-control player-input";
    playerNameInput.placeholder = "Enter player's name";
    playerNameInput.addEventListener('input', function() {
      // Call the autocomplete function when input changes
      autocomplete(this);
    });
    playerNameCell.appendChild(playerNameInput);
    row.appendChild(playerNameCell);
    
    var positionCell = document.createElement("td");
    positionCell.textContent = positions[i];
    row.appendChild(positionCell);
    
    var statCell = document.createElement("td");
    var statSquare = document.createElement("div");
    statSquare.className = "stat-square";
    statCell.appendChild(statSquare);
    row.appendChild(statCell);
    
    var submitCell = document.createElement("td");
    var submitButton = document.createElement("button");
    submitButton.type = "button";
    submitButton.className = "btn btn-primary";
    submitButton.textContent = "Submit";
    submitButton.addEventListener('click', handleSubmit);
    submitCell.appendChild(submitButton);
    row.appendChild(submitCell);
    
    tbody.appendChild(row);
    
    if (positions[i] === 'P') {
      break; // Stop adding rows when reaching 'P' position
    }
  }
}

function updateTotalScore() {
  var statSquares = document.querySelectorAll('.stat-square');
  var totalScore = 0;
  statSquares.forEach(function(statSquare) {
    var statValue = parseInt(statSquare.textContent);
    if (!isNaN(statValue)) {
      totalScore += statValue;
    }
  });
  document.getElementById('totalScore').textContent = totalScore;
}

// Autocomplete function
function autocomplete(input) {
  var currentFocus;
  var xhr = new XMLHttpRequest();
  xhr.onreadystatechange = function() {
    if (this.readyState === 4 && this.status === 200) {
      var suggestions = JSON.parse(this.responseText);
      closeAllLists();
      if (!input.value || suggestions.length === 0) {
        return false;
      }
      currentFocus = -1;
      var autocompleteList = document.createElement("div");
      autocompleteList.setAttribute("id", input.id + "autocomplete-list");
      autocompleteList.setAttribute("class", "autocomplete-items");
      input.parentNode.appendChild(autocompleteList);
      for (var i = 0; i < suggestions.length; i++) {
        var suggestion = suggestions[i];
        var suggestionItem = document.createElement("div");
        suggestionItem.innerHTML = "<strong>" + suggestion.substr(0, input.value.length) + "</strong>";
        suggestionItem.innerHTML += suggestion.substr(input.value.length);
        suggestionItem.innerHTML += "<input type='hidden' value='" + suggestion + "'>";
        suggestionItem.addEventListener("click", function(e) {
          input.value = this.getElementsByTagName("input")[0].value;
          closeAllLists();
        });
        autocompleteList.appendChild(suggestionItem);
      }
    }
  };
  // Dynamically determine the base URL
  var baseUrl = window.location.protocol + '//' + window.location.hostname;
  xhr.open("GET", baseUrl + "/autocomplete?query=" + input.value, true);
  xhr.send();
}

function closeAllLists(elmnt) {
  var autocompleteItems = document.getElementsByClassName("autocomplete-items");
  for (var i = 0; i < autocompleteItems.length; i++) {
    if (elmnt !== autocompleteItems[i] && elmnt !== input) {
      autocompleteItems[i].parentNode.removeChild(autocompleteItems[i]);
    }
  }
}

document.addEventListener("click", function(e) {
  closeAllLists(e.target);
});

window.onload = function() {
  updateLabels();
  
  // Trigger the modal when the instructions button is clicked
  document.getElementById('instructionsButton').addEventListener('click', function() {
    $('#instructionsModal').modal('show');
  });
};
</script>

</body>
</html>

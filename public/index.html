<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>All Time Teams</title>
<link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
<style>
  body {
    background-color: #71A95A; /* Green like Wrigley Field grass */
    font-family: Arial, sans-serif;
  }
  .container {
    margin-top: 20px;
    background-color: #FAFAD2; /* Sand color */
    padding: 20px;
    border-radius: 10px;
  }
  table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 20px;
    background-color: #FAFAD2; /* Sand color */
  }
  th, td {
    border: 1px solid #dddddd;
    text-align: left;
    padding: 8px;
  }
  th {
    background-color: #f2f2f2; /* Light gray header */
  }
  .stat-square {
    width: 30px;
    height: 30px;
    background-color: #ffffff; /* White square */
    border: 1px solid #dddddd;
  }
</style>
</head>
<body>

<div class="container">
  <div class="d-flex justify-content-between align-items-center">
    <h2>All Time Teams</h2>
    <button type="button" class="btn btn-primary" id="instructionsButton">Instructions</button>
  </div>
  <table class="table table-bordered">
    <thead>
      <tr>
        <th id="teamLabel"></th>
        <th>Position</th>
        <th id="statLabel">Stat</th> <!-- New column for Stat -->
        <th>Submit Player</th> <!-- New column for submit button -->
      </tr>
    </thead>
    <tbody id="playerRows">
      <!-- Table rows will be generated dynamically -->
    </tbody>
  </table>

  <!-- Total Score -->
  <div>
    <p>Total Score: <span id="totalScore"></span></p>
  </div>
</div>

<!-- Instructions Modal -->
<div class="modal fade" id="instructionsModal" tabindex="-1" role="dialog" aria-labelledby="instructionsModalLabel" aria-hidden="true">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="instructionsModalLabel">Instructions</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <p>Build an All Time Team! Choose a player who played for the given team and position. The score will be that player's highest season stat total for that category. Your total score is the sum of all the players' scores. Have fun!</p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
      </div> 
    </div>
  </div>
</div>

<script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.9.2/dist/umd/popper.min.js"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
<script>
// Array to keep track of submitted player names
var submittedPlayers = [];

// Function to fetch team and stat pair from the server
function fetchTeamStatPair() {
  // Dynamically determine the base URL
  var baseUrl = window.location.protocol + '//' + window.location.hostname;
  fetch(baseUrl + '/fetch-gameboard')
    .then(response => response.json())
    .then(data => {
      updateLabels(data.team_name, data.stat_name);
    })
    .catch(error => {
      console.error('Error fetching team and stat pair:', error);
    });
}

// Function to update labels with fetched team and stat pair
function updateLabels(team, stat) {
  document.getElementById('teamLabel').innerText = team;
  document.getElementById('statLabel').innerText = stat;
}

// Function to handle form submission
function handleSubmit(event) {
  var submitButton = event.target;
  if (submitButton.disabled) return; // Check if the button is already disabled
  submitButton.disabled = true; // Disable the button to prevent multiple submissions

  var playerNameInput = submitButton.parentElement.parentElement.children[0].children[0];
  var playerName = playerNameInput.value.trim(); // Trim whitespace

  // Check if the player has already been submitted
  if (submittedPlayers.includes(playerName)) {
    alert('Player has already been submitted. Please select a different player.');
    submitButton.disabled = false; // Re-enable the button
    return;
  }

  if (playerName !== '') {
    submittedPlayers.push(playerName); // Add the player to the submitted players list

    var position = submitButton.parentElement.parentElement.children[1].textContent;
    var team = document.getElementById('teamLabel').textContent;
    var stat = document.getElementById('statLabel').textContent; // Retrieve the value of the stats label

    // Dynamically determine the base URL
    var baseUrl = window.location.protocol + '//' + window.location.hostname;

    // Fetch data for the submitted player
    var xhr = new XMLHttpRequest();
    xhr.open('GET', baseUrl + '/search?playerName=' + playerName + '&position=' + position + '&team=' + team + '&stat=' + stat, true);
    xhr.onload = function () {
      if (xhr.status === 200) {
        var statSquare = submitButton.parentElement.parentElement.children[2].children[0];
        var statValue = xhr.responseText;
        statSquare.textContent = (statValue === 'null') ? 'N/A' : statValue; // Display 'N/A' if no data found. I'm trying here to handle the case where the player did not play that position or for that team (N/A instead of 0 in this case)
        updateTotalScore(); // Update total score after each submission
        
        // After updating the total score, check if all submit buttons are disabled
        var allDisabled = [...document.querySelectorAll('button.btn-primary')].every(button => button.disabled);
        if (allDisabled) {
          // If all submit buttons are disabled, send the total score to the server
          var totalScore = document.getElementById('totalScore').textContent;

          // Fetch the gameboardId associated with the current gameboard
          fetch(baseUrl + '/gameboardId')
            .then(response => response.json())
            .then(data => {
              var gameboardId = data.gameboardId;

              // Send the total score along with the team, stat, and gameboardId to the server
              saveScore(totalScore, team, stat);
            })
            .catch(error => {
              console.error('Error fetching gameboardId:', error);
            });
        }
      }
    };
    xhr.send();
  }
}

// Function to update total score
function updateTotalScore() {
  var totalScore = 0;
  var statSquares = document.querySelectorAll('.stat-square');
  statSquares.forEach(square => {
    var value = square.textContent;
    if (value !== 'N/A') { // Only add to total score if the value is not 'N/A'
      totalScore += parseInt(value);
    }
  });
  document.getElementById('totalScore').textContent = totalScore;
}

// Function to handle saving total score to the games table
function saveScore(totalScore, teamName, statName) {
  // Prepare the data to be sent
  const data = {
    totalScore: totalScore,
    teamName: teamName,
    statName: statName
  };

  // Send the data using a POST request
  fetch('/save-score', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json'
    },
    body: JSON.stringify(data)
  })
  .then(response => {
    if (!response.ok) {
      throw new Error('Network response was not ok');
    }
    console.log('Total score saved successfully');
    // Optionally, you can handle success response here
  })
  .catch(error => {
    console.error('Error saving total score:', error);
    // Optionally, you can handle error here
  });
}

// Event listener for the instructions button
document.getElementById('instructionsButton').addEventListener('click', function () {
  $('#instructionsModal').modal('show');
});

// Fetch team and stat pair on page load
fetchTeamStatPair();
</script>
</body>
</html>


